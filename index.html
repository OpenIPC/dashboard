<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' video-archive:; script-src 'self' 'unsafe-eval'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; connect-src 'self' ws://localhost:*; img-src 'self' data:;">
    <title>DASHBOARD for OpenIPC</title>
    
    <!-- Ссылки на внешние стили -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="node_modules/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="css/main.css">
</head>
<body>
    <!-- 
        Основная разметка приложения.
        Все модальные окна и архив будут загружены динамически из templates.html
    -->

    <!-- Экран входа -->
    <div id="login-view" class="modal-backdrop">
        <div class="modal-content" style="width: 400px; text-align: center;">
            
            <span id="login-close-btn" class="modal-close-btn">&times;</span>

            <h2 data-i18n-key="app_title"></h2>
            <p data-i18n-key="login_prompt" style="color: #6c757d;"></p>
            <div class="form-grid simple" style="grid-template-columns: 100px 1fr; padding-top: 10px;">
                <b data-i18n-key="login"></b> <input type="text" id="login-username" autofocus>
                <b data-i18n-key="password"></b> <input type="password" id="login-password">
                
                <!-- VVVVVV --- ИЗМЕНЕНИЕ ЗДЕСЬ --- VVVVVV -->
                <!-- Пустой <b> удален, чтобы не создавать лишнюю ячейку -->
                <div class="form-check-inline">
                    <input type="checkbox" id="login-remember-me" class="form-check-input">
                    <label for="login-remember-me" data-i18n-key="remember_me"></label>
                </div>
            
            </div> <!-- <-- ВОТ ЭТОТ ЗАКРЫВАЮЩИЙ ТЕГ БЫЛ ПРОПУЩЕН И ТЕПЕРЬ ДОБАВЛЕН -->
            <!-- ^^^^^^ --- КОНЕЦ ИЗМЕНЕНИЯ --- ^^^^^^ -->
            
            <p id="login-error" style="color: var(--danger-color); height: 20px; margin-top: 10px;"></p>
            <button id="login-btn" style="width: 100%; padding: 10px; margin-top: 5px;" data-i18n-key="login_btn"></button>
        </div>
    </div>

    <!-- Основной контейнер приложения -->
    <div id="main-app-container" class="hidden" style="display: flex; flex-direction: column; height: 100vh;">
        <!-- Заголовок -->
        <div class="header">
            <div class="logo" data-i18n-key="app_title"></div>
            <div class="tabs">
                <!-- Вкладки будут добавлены сюда динамически -->
            </div>
            <button id="add-layout-btn" class="add-tab-btn" data-i18n-tooltip="add_layout_tooltip">+</button>
            <div class="window-controls">
                <button id="minimize-btn" class="window-control-btn"><i class="material-icons">remove</i></button>
                <button id="maximize-btn" class="window-control-btn"><i class="material-icons">crop_square</i></button>
                <button id="close-btn" class="window-control-btn close-btn"><i class="material-icons">close</i></button>
            </div>
        </div>

        <!-- Главное содержимое (сетка и боковая панель) -->
        <div id="main-view" class="main-container">
            <div class="view-container">
                <div id="grid-container"></div>
            </div>
            <div class="sidebar">
                <div class="sidebar-header">
                    <div class="header-buttons">
                        <span class="requires-permission" style="display: contents;">
                            <button id="discover-btn" class="icon-button" data-i18n-tooltip="discover_cameras_tooltip"><i class="material-icons">travel_explore</i></button>
                            <button id="add-group-btn" class="icon-button" data-i18n-tooltip="create_group_tooltip"><i class="material-icons">create_new_folder</i></button>
                            <button id="add-camera-sidebar-btn" class="icon-button" data-i18n-tooltip="add_camera_tooltip"><i class="material-icons">add_circle_outline</i></button>
                        </span>
                        <button id="user-management-btn" class="icon-button admin-only" data-i18n-tooltip="user_management_tooltip"><i class="material-icons">manage_accounts</i></button>
                        <button id="general-settings-btn" class="icon-button" data-i18n-tooltip="settings_tooltip"><i class="material-icons">settings</i></button>
                        <button id="logout-btn" class="icon-button" data-i18n-tooltip="logout_tooltip"><i class="material-icons">logout</i></button>
                    </div>
                    <h3 data-i18n-key="devices"></h3>
                </div>
                <div id="camera-list-container"></div>
            </div>
        </div>
        
        <!-- Нижняя панель инструментов -->
        <div class="bottom-toolbar">
            <div class="toolbar-group">
                <button id="open-recordings-btn" class="icon-button admin-only" data-i18n-tooltip="open_recordings_tooltip"><i class="material-icons" style="font-size: 20px;">folder</i></button>
                <div class="status-info" id="status-info"></div>
            </div>
            <div class="toolbar-group requires-permission" id="view-layout-controls">
                <button id="save-layout-btn" class="icon-button" data-i18n-tooltip="save_layout_tooltip"><i class="material-icons">save</i></button>
                <button id="rename-layout-btn" class="icon-button" data-i18n-tooltip="rename_layout_tooltip"><i class="material-icons">edit</i></button>
                <button id="delete-layout-btn" class="icon-button" data-i18n-tooltip="delete_layout_tooltip"><i class="material-icons">delete_outline</i></button>
            </div>
            <div class="toolbar-group requires-permission" id="layout-controls"></div>
            <div class="toolbar-group">
                <button id="presentation-mode-btn" class="icon-button requires-permission" data-i18n-tooltip="presentation_mode_tooltip"><i class="material-icons" style="font-size: 20px;">tv</i></button>
            </div>
        </div>
    </div>

    <!-- === НАЧАЛО ИЗМЕНЕНИЙ (ИСПРАВЛЕНА СТРУКТУРА ШАБЛОНА) === -->
    <template id="grid-cell-content-template">
        <div class="video-wrapper">
            <!-- Видео и оверлей для рамок -->
            <canvas class="video-canvas"></canvas>
            <canvas class="overlay-canvas"></canvas>

            <!-- ВСЕ ОВЕРЛЕИ ПЕРЕМЕЩЕНЫ ВНУТРЬ video-wrapper -->
            <div class="cell-controls">
                <button class="record-btn" title="Запись"><i class="material-icons">fiber_manual_record</i></button>
                <button class="audio-btn" title="Звук"><i class="material-icons">volume_off</i></button>
                <button class="stream-switch-btn" title="Переключить поток (HD/SD)"><i class="material-icons">hd</i></button>
                <button class="fullscreen-btn" title="На весь экран"><i class="material-icons">fullscreen</i></button>
                <button class="close-btn" title="Закрыть"><i class="material-icons">close</i></button>
            </div>
            <div class="ptz-overlay">
                <div class="ptz-btn ptz-up" data-command="tilt_up" title="Вверх"><i class="material-icons">keyboard_arrow_up</i></div>
                <div class="ptz-btn ptz-down" data-command="tilt_down" title="Вниз"><i class="material-icons">keyboard_arrow_down</i></div>
                <div class="ptz-btn ptz-left" data-command="pan_left" title="Влево"><i class="material-icons">keyboard_arrow_left</i></div>
                <div class="ptz-btn ptz-right" data-command="pan_right" title="Вправо"><i class="material-icons">keyboard_arrow_right</i></div>
            </div>
            <div class="ptz-zoom-controls">
                <div class="ptz-btn ptz-zoom-in" data-command="zoom_in" title="Приблизить"><i class="material-icons">add</i></div>
                <div class="ptz-btn ptz-home" data-command="go_home" title="Домой"><i class="material-icons">home</i></div>
                <div class="ptz-btn ptz-zoom-out" data-command="zoom_out" title="Отдалить"><i class="material-icons">remove</i></div>
            </div>
            <div class="cell-name"></div>
            <div class="cell-stats"></div>
        </div>
    </template>
    <!-- === КОНЕЦ ИЗМЕНЕНИЙ === -->
    <div id="app-toast" class="toast-notification"></div>
    <!-- Подключение скриптов -->
    <script src="jsmpeg.min.js"></script>
    <script src="node_modules/flatpickr/dist/flatpickr.js"></script>
    <script src="node_modules/flatpickr/dist/l10n/ru.js"></script>
    <script src="./js/i18n.js"></script>
    <script src="./js/state-manager.js"></script>
    <script src="./js/modals/camera-handler.js"></script>
    <script src="./js/modals/settings-handler.js"></script>
    <script src="./js/modals/user-handler.js"></script>
    <script src="./js/modal-handler.js"></script>
    <script src="./js/camera-list.js"></script>
    <script src="./js/grid-manager.js"></script>
    <script src="./js/archive-manager.js"></script>
    <script src="./js/window-controls.js"></script>
    <script src="./js/renderer.js"></script>
</body>
</html>